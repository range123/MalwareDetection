''' File that contains functions for preprocessing the dataset '''

import os
import json
from pathlib import Path

import pandas as pd
import numpy as np

from utils import softwares

def parse_json(path,malware=0):

    file_name = os.path.basename(path).split('.')[0]
    # print(file_name)
    data = json.load(open(path,'r'))
    res = {}
    res['file_name'] = file_name
    for i in range(1,11):
        res[i] = 0
    for sign in data['signatures']:
        try:
            res[sign['severity']] += 1
        except:
            pass
    for software in softwares:
        res[software] = -1
    try:
        for software,det in data['virustotal']['scans'].items():
            res[software] = int(det['detected'])
    except:
        pass
    res['malware'] = malware
    return res

def get_dynamic_data_list(dynamic_path):
    data_list = []
    total_files = 0
    pathlist = Path(dynamic_path).glob('**/*.json')
    for path in pathlist:
        path_in_str = str(path)
        total_files+=1
        try:
            if 'malware' in path_in_str.lower():
                data_list.append(parse_json(path_in_str,1))
            else:
                data_list.append(parse_json(path_in_str,0))
        except:
            pass
        # For progress checking purposes
        # if total_files%100 == 0:
            # print(total_files)
    return data_list

def get_static_data_list(static_path):
    data_list = []
    total_files = 0
    pathlist = Path(static_path).glob('**/*.txt')
    for path in pathlist:
        path_in_str = str(path)
        res = {}
        if path_in_str.lower().endswith('string.txt'):
            total_files+=1
            file_name = os.path.split(os.path.split(path_in_str)[0])[1]
            res['file_name'] = file_name
            with open(path_in_str,'r',errors='ignore') as f1:
                res['string'] = f1.read()
            if 'malware' in path_in_str.lower():
                res['malware'] = 1
            else:
                res['malware'] = 0
            data_list.append(res)
        # For progress checking purposes
        # if total_files%100 == 0:
            # print(total_files)
    return data_list

if __name__ == '__main__':

    static = './Static_Analysis_Data'
    dynamic1 = './Dynamic_Analysis_Data_Part1'
    dynamic2 = './Dynamic_Analysis_Data_Part2'

    
    d_result = get_dynamic_data_list(dynamic1)
    d_result.extend(get_dynamic_data_list(dynamic2))

    s_result = get_static_data_list(static)

    data_frame_dynamic = pd.DataFrame(d_result)
    data_frame_static = pd.DataFrame(s_result)

    data_frame_dynamic.to_csv('train_data_dynamic.csv',index=False)
    data_frame_static.to_csv('train_data_static.csv',index=False)
